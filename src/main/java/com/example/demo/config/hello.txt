----------config ----------
SecurityConfig.java




SwaggerConfig.java





-----controller-------
ActivityCategoryController.java






ActivityTypeController.java



AdminController.java





AuthController.java





EmissionFactorController.java





TestController.java





UserController.java







-------dto--------
ActivityLogRequest.java




ActivityTypeRequest.java



CategoryRequest.java





EmissionFactorRequest.java




LoginRequest.java





RegisterRequest.java






------entity------
ActivityCategory.java




ActivityLog.java





ActivityType.java





EmissionFactor.java




User.java






-------exception-------



ValidationException.java





------repository-----
ActivityCategoryRepository.java




ActivityLogRepository.java




ActivityTypeRepository.java




EmissionFactorRepository.java
package com.example.demo.repository;

import com.example.demo.entity.EmissionFactor;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EmissionFactorRepository extends JpaRepository<EmissionFactor, Long> {
Optional<EmissionFactor> findByActivityType_Id(Long activityTypeId);
}




UserRepository.java
package com.example.demo.repository;

import com.example.demo.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface UserRepository extends JpaRepository<User, Long> {
boolean existsByEmail(String email);
Optional<User> findByEmail(String email);
}





-------security-------
CustomUserDetailsService.java
package com.example.demo.security;

import com.example.demo.entity.User;
import com.example.demo.repository.UserRepository;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.Collections;

@Service
public class CustomUserDetailsService implements UserDetailsService {
private final UserRepository userRepository;

public CustomUserDetailsService(UserRepository userRepository) {
this.userRepository = userRepository;
}

@Override
public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
User user = userRepository.findByEmail(email)
.orElseThrow(() -> new UsernameNotFoundException("User not found with email: " + email));

return org.springframework.security.core.userdetails.User.builder()
.username(user.getEmail())
.password(user.getPassword())
.authorities(Collections.singletonList(new SimpleGrantedAuthority("ROLE_" + user.getRole())))
.build();
}
}






JwtAuthenticationFilter.java
package com.example.demo.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Collections;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
private final JwtUtil jwtUtil;

public JwtAuthenticationFilter(JwtUtil jwtUtil) {
this.jwtUtil = jwtUtil;
}

@Override
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
FilterChain filterChain) throws ServletException, IOException {
String authHeader = request.getHeader("Authorization");

if (authHeader != null && authHeader.startsWith("Bearer ")) {
String token = authHeader.substring(7);
try {
String username = jwtUtil.extractUsername(token);
String role = jwtUtil.extractRole(token);

if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
if (jwtUtil.isTokenValid(token, username)) {
UsernamePasswordAuthenticationToken authToken =
new UsernamePasswordAuthenticationToken(
username,
null,
Collections.singletonList(new SimpleGrantedAuthority("ROLE_" + role))
);
SecurityContextHolder.getContext().setAuthentication(authToken);
}
}
} catch (Exception e) {
// Invalid token, continue without authentication
}
}

filterChain.doFilter(request, response);
}
}







JwtUtil.java
package com.example.demo.security;

import com.example.demo.entity.User;
import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

@Component
public class JwtUtil {

@Value("${jwt.secret:mySecretKey}")
private String secret;

@Value("${jwt.expiration:86400000}")
private Long expiration;

public JwtUtil() {
// Default values for testing
if (this.secret == null) {
this.secret = "mySecretKeyThatIsLongEnoughForJWTHMACAlgorithmRequirements";
}
if (this.expiration == null) {
this.expiration = 86400000L;
}
}

private SecretKey getSigningKey() {
return Keys.hmacShaKeyFor(secret.getBytes());
}

public String generateToken(Map<String, Object> claims, String subject) {
return Jwts.builder()
.setClaims(claims)
.setSubject(subject)
.setIssuedAt(new Date())
.setExpiration(new Date(System.currentTimeMillis() + expiration))
.signWith(getSigningKey())
.compact();
}

public String generateTokenForUser(User user) {
Map<String, Object> claims = new HashMap<>();
claims.put("userId", user.getId());
claims.put("email", user.getEmail());
claims.put("role", user.getRole());
return generateToken(claims, user.getEmail());
}

public String extractUsername(String token) {
return extractClaim(token, Claims::getSubject);
}

public String extractRole(String token) {
return extractClaim(token, claims -> claims.get("role", String.class));
}

public Long extractUserId(String token) {
return extractClaim(token, claims -> {
Object userId = claims.get("userId");
if (userId instanceof Integer) {
return ((Integer) userId).longValue();
}
return (Long) userId;
});
}

public <T> T extractClaim(String token, java.util.function.Function<Claims, T> claimsResolver) {
final Claims claims = extractAllClaims(token);
return claimsResolver.apply(claims);
}

private Claims extractAllClaims(String token) {
return Jwts.parserBuilder()
.setSigningKey(getSigningKey())
.build()
.parseClaimsJws(token)
.getBody();
}

public boolean isTokenValid(String token, String username) {
final String extractedUsername = extractUsername(token);
return (extractedUsername.equals(username) && !isTokenExpired(token));
}

private boolean isTokenExpired(String token) {
return extractExpiration(token).before(new Date());
}

private Date extractExpiration(String token) {
return extractClaim(token, Claims::getExpiration);
}

public JwtWrapper parseToken(String token) {
final Claims claims = extractAllClaims(token);
return new JwtWrapper(claims);
}

public static class JwtWrapper {
private final Claims payload;

public JwtWrapper(Claims payload) {
this.payload = payload;
}

public Claims getPayload() {
return payload;
}
}

public Claims extractAllClaimsForTest(String token) {
return extractAllClaims(token);
}
}







---------service---------
ActivityCategoryService.java
package com.example.demo.service;

import com.example.demo.entity.ActivityCategory;

import java.util.List;

public interface ActivityCategoryService {
ActivityCategory createCategory(ActivityCategory category);
ActivityCategory getCategory(Long id);
List<ActivityCategory> getAllCategories();
}



ActivityLogService.java
package com.example.demo.service;

import com.example.demo.entity.ActivityLog;

import java.time.LocalDate;
import java.util.List;

public interface ActivityLogService {
ActivityLog logActivity(Long userId, Long typeId, ActivityLog log);
List<ActivityLog> getLogsByUser(Long userId);
List<ActivityLog> getLogsByUserAndDate(Long userId, LocalDate start, LocalDate end);
ActivityLog getLog(Long id);
}


ActivityTypeService.java
package com.example.demo.service;

import com.example.demo.entity.ActivityType;

import java.util.List;

public interface ActivityTypeService {
ActivityType createType(Long categoryId, ActivityType type);
ActivityType getType(Long id);
List<ActivityType> getTypesByCategory(Long categoryId);
}



EmissionFactorService.java
package com.example.demo.service;

import com.example.demo.entity.EmissionFactor;

import java.util.List;

public interface EmissionFactorService {
EmissionFactor createFactor(Long activityTypeId, EmissionFactor factor);
EmissionFactor getFactor(Long id);
EmissionFactor getFactorByType(Long typeId);
List<EmissionFactor> getAllFactors();
}


UserService.java
package com.example.demo.service;

import com.example.demo.entity.User;

import java.util.List;

public interface UserService {
User registerUser(User user);
User getUser(Long id);
List<User> getAllUsers();
User getByEmail(String email);
}




package com.example.demo.service.impl;

import com.example.demo.entity.ActivityCategory;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.exception.ValidationException;
import com.example.demo.repository.ActivityCategoryRepository;
import com.example.demo.service.ActivityCategoryService;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class ActivityCategoryServiceImpl implements ActivityCategoryService {
private final ActivityCategoryRepository categoryRepository;

public ActivityCategoryServiceImpl(ActivityCategoryRepository categoryRepository) {
this.categoryRepository = categoryRepository;
}

@Override
public ActivityCategory createCategory(ActivityCategory category) {
if (categoryRepository.existsByCategoryName(category.getCategoryName())) {
throw new ValidationException("Category name must be unique");
}
return categoryRepository.save(category);
}

@Override
public ActivityCategory getCategory(Long id) {
return categoryRepository.findById(id)
.orElseThrow(() -> new ResourceNotFoundException("Category not found"));
}

@Override
public List<ActivityCategory> getAllCategories() {
return categoryRepository.findAll();
}
}


package com.example.demo.service.impl;

import com.example.demo.entity.ActivityLog;
import com.example.demo.entity.ActivityType;
import com.example.demo.entity.EmissionFactor;
import com.example.demo.entity.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.exception.ValidationException;
import com.example.demo.repository.ActivityLogRepository;
import com.example.demo.repository.ActivityTypeRepository;
import com.example.demo.repository.EmissionFactorRepository;
import com.example.demo.repository.UserRepository;
import com.example.demo.service.ActivityLogService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.util.List;

@Service
@Transactional
public class ActivityLogServiceImpl implements ActivityLogService {
private final ActivityLogRepository logRepository;
private final UserRepository userRepository;
private final ActivityTypeRepository typeRepository;
private final EmissionFactorRepository factorRepository;

public ActivityLogServiceImpl(ActivityLogRepository logRepository, UserRepository userRepository,
ActivityTypeRepository typeRepository, EmissionFactorRepository factorRepository) {
this.logRepository = logRepository;
this.userRepository = userRepository;
this.typeRepository = typeRepository;
this.factorRepository = factorRepository;
}

@Override
public ActivityLog logActivity(Long userId, Long typeId, ActivityLog log) {
User user = userRepository.findById(userId)
.orElseThrow(() -> new ResourceNotFoundException("User not found"));

ActivityType activityType = typeRepository.findById(typeId)
.orElseThrow(() -> new ResourceNotFoundException("Category not found"));

if (log.getActivityDate().isAfter(LocalDate.now())) {
throw new ValidationException("Activity date cannot be in the future");
}

if (log.getQuantity() <= 0) {
throw new ValidationException("Quantity must be greater than 0");
}

EmissionFactor factor = factorRepository.findByActivityType_Id(typeId)
.orElseThrow(() -> new ValidationException("No emission factor configured"));

log.setUser(user);
log.setActivityType(activityType);
log.setEstimatedEmission(log.getQuantity() * factor.getFactorValue());

return logRepository.save(log);
}

@Override
public List<ActivityLog> getLogsByUser(Long userId) {
return logRepository.findByUser_Id(userId);
}

@Override
public List<ActivityLog> getLogsByUserAndDate(Long userId, LocalDate start, LocalDate end) {
return logRepository.findByUser_IdAndActivityDateBetween(userId, start, end);
}

@Override
public ActivityLog getLog(Long id) {
return logRepository.findById(id)
.orElseThrow(() -> new ResourceNotFoundException("Activity log not found"));
}
}




package com.example.demo.service.impl;

import com.example.demo.entity.ActivityCategory;
import com.example.demo.entity.ActivityType;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.exception.ValidationException;
import com.example.demo.repository.ActivityCategoryRepository;
import com.example.demo.repository.ActivityTypeRepository;
import com.example.demo.service.ActivityTypeService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@Transactional
public class ActivityTypeServiceImpl implements ActivityTypeService {
private final ActivityTypeRepository typeRepository;
private final ActivityCategoryRepository categoryRepository;

public ActivityTypeServiceImpl(ActivityTypeRepository typeRepository, ActivityCategoryRepository categoryRepository) {
this.typeRepository = typeRepository;
this.categoryRepository = categoryRepository;
}

@Override
public ActivityType createType(Long categoryId, ActivityType type) {
ActivityCategory category = categoryRepository.findById(categoryId)
.orElseThrow(() -> new ResourceNotFoundException("Category not found"));

if (type.getUnit() == null || type.getUnit().trim().isEmpty()) {
throw new ValidationException("Unit is required");
}

type.setCategory(category);
return typeRepository.save(type);
}

@Override
public ActivityType getType(Long id) {
return typeRepository.findById(id)
.orElseThrow(() -> new ResourceNotFoundException("Activity type not found"));
}

@Override
public List<ActivityType> getTypesByCategory(Long categoryId) {
return typeRepository.findByCategory_Id(categoryId);
}
}






package com.example.demo.service.impl;

import com.example.demo.entity.ActivityType;
import com.example.demo.entity.EmissionFactor;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.exception.ValidationException;
import com.example.demo.repository.ActivityTypeRepository;
import com.example.demo.repository.EmissionFactorRepository;
import com.example.demo.service.EmissionFactorService;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class EmissionFactorServiceImpl implements EmissionFactorService {
private final EmissionFactorRepository factorRepository;
private final ActivityTypeRepository typeRepository;

public EmissionFactorServiceImpl(EmissionFactorRepository factorRepository, ActivityTypeRepository typeRepository) {
this.factorRepository = factorRepository;
this.typeRepository = typeRepository;
}

@Override
public EmissionFactor createFactor(Long activityTypeId, EmissionFactor factor) {
ActivityType activityType = typeRepository.findById(activityTypeId)
.orElseThrow(() -> new ResourceNotFoundException("Category not found"));

if (factor.getFactorValue() <= 0) {
throw new ValidationException("Factor value must be greater than 0");
}

factor.setActivityType(activityType);
return factorRepository.save(factor);
}

@Override
public EmissionFactor getFactor(Long id) {
return factorRepository.findById(id)
.orElseThrow(() -> new ResourceNotFoundException("Emission factor not found"));
}

@Override
public EmissionFactor getFactorByType(Long typeId) {
return factorRepository.findByActivityType_Id(typeId)
.orElseThrow(() -> new ResourceNotFoundException("Emission factor not found"));
}

@Override
public List<EmissionFactor> getAllFactors() {
return factorRepository.findAll();
}
}







package com.example.demo.service.impl;

import com.example.demo.entity.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.exception.ValidationException;
import com.example.demo.repository.UserRepository;
import com.example.demo.service.UserService;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class UserServiceImpl implements UserService {
private final UserRepository userRepository;
private final PasswordEncoder passwordEncoder;

public UserServiceImpl(UserRepository userRepository, PasswordEncoder passwordEncoder) {
this.userRepository = userRepository;
this.passwordEncoder = passwordEncoder;
}

@Override
public User registerUser(User user) {
if (userRepository.existsByEmail(user.getEmail())) {
throw new ValidationException("Email already in use");
}

if (user.getPassword().length() < 8) {
throw new ValidationException("Password must be at least 8 characters");
}

if (passwordEncoder != null) {
user.setPassword(passwordEncoder.encode(user.getPassword()));
}
if (user.getRole() == null) {
user.setRole("USER");
}

return userRepository.save(user);
}

@Override
public User getUser(Long id) {
return userRepository.findById(id)
.orElseThrow(() -> new ResourceNotFoundException("User not found"));
}

@Override
public List<User> getAllUsers() {
return userRepository.findAll();
}

@Override
public User getByEmail(String email) {
return userRepository.findByEmail(email)
.orElseThrow(() -> new ResourceNotFoundException("User not found"));
}
}




DemoApplication.java
package com.example.demo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class DemoApplication {

public static void main(String[] args) {
SpringApplication.run(DemoApplication.class, args);
}

}




pom.xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
<modelVersion>4.0.0</modelVersion>
<parent>
<groupId>org.springframework.boot</groupId>
<artifactId>spring-boot-starter-parent</artifactId>
<version>3.2.0</version>
<relativePath/> <!-- lookup parent from repository -->
</parent>
<groupId>com.example</groupId>
<artifactId>demo</artifactId>
<version>0.0.1-SNAPSHOT</version>
<name>demo</name>
<description>Demo project for Spring Boot</description>
<url/>
<licenses>
<license/>
</licenses>
<developers>
<developer/>
</developers>
<scm>
<connection/>
<developerConnection/>
<tag/>
<url/>
</scm>
<properties>
<java.version>21</java.version>
</properties>
<dependencies>
<dependency>
<groupId>org.springframework.boot</groupId>
<artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
<dependency>
<groupId>org.springframework.boot</groupId>
<artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
<groupId>org.springframework.boot</groupId>
<artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
<groupId>org.springframework.boot</groupId>
<artifactId>spring-boot-starter-validation</artifactId>
</dependency>
<dependency>
<groupId>io.jsonwebtoken</groupId>
<artifactId>jjwt-api</artifactId>
<version>0.11.5</version>
</dependency>
<dependency>
<groupId>io.jsonwebtoken</groupId>
<artifactId>jjwt-impl</artifactId>
<version>0.11.5</version>
<scope>runtime</scope>
</dependency>
<dependency>
<groupId>io.jsonwebtoken</groupId>
<artifactId>jjwt-jackson</artifactId>
<version>0.11.5</version>
<scope>runtime</scope>
</dependency>
<dependency>
<groupId>org.springdoc</groupId>
<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
<version>2.2.0</version>
</dependency>
<dependency>
<groupId>com.mysql</groupId>
<artifactId>mysql-connector-j</artifactId>
<scope>runtime</scope>
</dependency>
<dependency>
<groupId>com.h2database</groupId>
<artifactId>h2</artifactId>
<scope>runtime</scope>
</dependency>
<dependency>
<groupId>org.springframework.boot</groupId>
<artifactId>spring-boot-starter-test</artifactId>
<scope>test</scope>
</dependency>
<dependency>
<groupId>org.springframework.security</groupId>
<artifactId>spring-security-test</artifactId>
<scope>test</scope>
</dependency>
<dependency>
<groupId>org.testng</groupId>
<artifactId>testng</artifactId>
<version>7.8.0</version>
<scope>test</scope>
</dependency>
<dependency>
<groupId>org.mockito</groupId>
<artifactId>mockito-core</artifactId>
<scope>test</scope>
</dependency>
</dependencies>

<build>
<plugins>
<plugin>
<groupId>org.springframework.boot</groupId>
<artifactId>spring-boot-maven-plugin</artifactId>
</plugin>
<plugin>
<groupId>org.apache.maven.plugins</groupId>
<artifactId>maven-surefire-plugin</artifactId>
<version>3.1.2</version>
<dependencies>
<dependency>
<groupId>org.apache.maven.surefire</groupId>
<artifactId>surefire-testng</artifactId>
<version>3.1.2</version>
</dependency>
</dependencies>
<configuration>
<includes>
<include>**/CarbonFootprintEstimatorTest.java</include>
</includes>
<excludes>
<exclude>**/DemoApplicationTests.java</exclude>
</excludes>
</configuration>
</plugin>
</plugins>
</build>

</project>







spring.application.name=demo

# Database Configuration (H2 for development)
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.username=sa
spring.datasource.password=
spring.datasource.driver-class-name=org.h2.Driver
spring.h2.console.enabled=true

# JPA Configuration
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=true

# JWT Configuration
jwt.secret=mySecretKeyThatIsLongEnoughForJWTHMACAlgorithmRequirements
jwt.expiration=86400000

# Swagger Configuration
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.path=/swagger-ui/index.html









