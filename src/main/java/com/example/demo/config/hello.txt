
Folder: entity

ActivityCategory.java

 

 



 

 

ActivityLog.java



 

 

 

ActivityType.java



 

 

 

EmissionFactor.java



 

 

 

 

User.java



 

 

 

 

Folder: Exception

 



 

 

ResourceNotFoundException.java

package com.example.demo.exception;

 

public class ResourceNotFoundException extends RuntimeException {

    public ResourceNotFoundException(String message) {

        super(message);

    }

}

 

 

ValidationException.java

package com.example.demo.exception;

 

public class ValidationException extends RuntimeException {

    public ValidationException(String message) {

        super(message);

    }

}

 

 

Folder:Repository

ActivityCategoryRepository.java

package com.example.demo.repository;

 

import com.example.demo.entity.ActivityCategory;

import org.springframework.data.jpa.repository.JpaRepository;

import org.springframework.stereotype.Repository;

 

@Repository

public interface ActivityCategoryRepository extends JpaRepository<ActivityCategory, Long> {

    boolean existsByCategoryName(String categoryName);

}

 

 

 

 

 

 

ActivityLogRepository.java

package com.example.demo.repository;

 

import com.example.demo.entity.ActivityLog;

import org.springframework.data.jpa.repository.JpaRepository;

import org.springframework.stereotype.Repository;

 

import java.time.LocalDate;

import java.util.List;

 

@Repository

public interface ActivityLogRepository extends JpaRepository<ActivityLog, Long> {

    List<ActivityLog> findByUser_IdAndActivityDateBetween(Long userId, LocalDate start, LocalDate end);

    List<ActivityLog> findByUser_Id(Long userId);

}

 

 

 

 

ActivityTypeRepository.java

package com.example.demo.repository;

 

import com.example.demo.entity.ActivityType;

import org.springframework.data.jpa.repository.JpaRepository;

import org.springframework.stereotype.Repository;

 

import java.util.List;

 

@Repository

public interface ActivityTypeRepository extends JpaRepository<ActivityType, Long> {

    List<ActivityType> findByCategory_Id(Long categoryId);

}

 

 

EmissionFactorRepository.java

package com.example.demo.repository;

 

import com.example.demo.entity.EmissionFactor;

import org.springframework.data.jpa.repository.JpaRepository;

import org.springframework.stereotype.Repository;

 

import java.util.Optional;

 

@Repository

public interface EmissionFactorRepository extends JpaRepository<EmissionFactor, Long> {

    Optional<EmissionFactor> findByActivityType_Id(Long activityTypeId);

}

 

 

 

UserRepository.java

package com.example.demo.repository;

 

import com.example.demo.entity.User;

import org.springframework.data.jpa.repository.JpaRepository;

import org.springframework.stereotype.Repository;

 

import java.util.Optional;

 

@Repository

public interface UserRepository extends JpaRepository<User, Long> {

    boolean existsByEmail(String email);

    Optional<User> findByEmail(String email);

}

 

 

Folder : Security

 

CustomUserDetailsService.java

package com.example.demo.security;

 

import com.example.demo.entity.User;

import com.example.demo.repository.UserRepository;

import org.springframework.security.core.authority.SimpleGrantedAuthority;

import org.springframework.security.core.userdetails.UserDetails;

import org.springframework.security.core.userdetails.UserDetailsService;

import org.springframework.security.core.userdetails.UsernameNotFoundException;

import org.springframework.stereotype.Service;

 

import java.util.Collections;

 

@Service

public class CustomUserDetailsService implements UserDetailsService {

   

    private final UserRepository userRepository;

   

    public CustomUserDetailsService(UserRepository userRepository) {

        this.userRepository = userRepository;

    }

   

    @Override

    public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {

        User user = userRepository.findByEmail(email)

                .orElseThrow(() -> new UsernameNotFoundException("User not found"));

       

        return org.springframework.security.core.userdetails.User.builder()

                .username(user.getEmail())

                .password(user.getPassword())

                .authorities(Collections.singletonList(new SimpleGrantedAuthority("ROLE_" + user.getRole())))

                .build();

    }

}

 

 

JwtAuthenticationFilter.java

 

package com.example.demo.security;

 

import jakarta.servlet.FilterChain;

import jakarta.servlet.ServletException;

import jakarta.servlet.http.HttpServletRequest;

import jakarta.servlet.http.HttpServletResponse;

import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;

import org.springframework.security.core.authority.SimpleGrantedAuthority;

import org.springframework.security.core.context.SecurityContextHolder;

import org.springframework.stereotype.Component;

import org.springframework.web.filter.OncePerRequestFilter;

 

import java.io.IOException;

import java.util.Collections;

 

@Component

public class JwtAuthenticationFilter extends OncePerRequestFilter {

   

    private final JwtUtil jwtUtil;

   

    public JwtAuthenticationFilter(JwtUtil jwtUtil) {

        this.jwtUtil = jwtUtil;

    }

   

    @Override

    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)

            throws ServletException, IOException {

       

        String authHeader = request.getHeader("Authorization");

       

        if (authHeader != null && authHeader.startsWith("Bearer ")) {

            String token = authHeader.substring(7);

           

            try {

                String email = jwtUtil.extractUsername(token);

                String role = jwtUtil.extractRole(token);

                Long userId = jwtUtil.extractUserId(token);

               

                if (email != null && SecurityContextHolder.getContext().getAuthentication() == null) {

                    if (jwtUtil.isTokenValid(token, email)) {

                        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(

                                email, null, Collections.singletonList(new SimpleGrantedAuthority("ROLE_" + role)));

                        SecurityContextHolder.getContext().setAuthentication(authToken);

                    }

                }

            } catch (Exception e) {

                // Invalid token, continue without authentication

            }

        }

       

        filterChain.doFilter(request, response);

    }

}

 

 

 

 

 

JwtUtil.java

package com.example.demo.security;

 

import com.example.demo.entity.User;

import io.jsonwebtoken.Claims;

import io.jsonwebtoken.Jwt;

import io.jsonwebtoken.Jwts;

 

import io.jsonwebtoken.security.Keys;

import org.springframework.stereotype.Component;

 

import javax.crypto.SecretKey;

import java.util.Date;

import java.util.HashMap;

import java.util.Map;

import java.util.function.Function;

 

@Component

public class JwtUtil {

   

    private static final String SECRET = "mySecretKeymySecretKeymySecretKeymySecretKey";

    private static final int JWT_EXPIRATION = 86400000; // 24 hours

   

    private SecretKey getSigningKey() {

        return Keys.hmacShaKeyFor(SECRET.getBytes());

    }

   

    public String generateToken(Map<String, Object> claims, String subject) {

        return Jwts.builder()

                .setClaims(claims)

                .setSubject(subject)

                .setIssuedAt(new Date(System.currentTimeMillis()))

                .setExpiration(new Date(System.currentTimeMillis() + JWT_EXPIRATION))

                .signWith(getSigningKey())

                .compact();

    }

   

    public String generateTokenForUser(User user) {

        Map<String, Object> claims = new HashMap<>();

        claims.put("userId", user.getId());

        claims.put("email", user.getEmail());

        claims.put("role", user.getRole());

        return generateToken(claims, user.getEmail());

    }

   

    public String extractUsername(String token) {

        return extractClaim(token, Claims::getSubject);

    }

   

    public String extractRole(String token) {

        return extractClaim(token, claims -> (String) claims.get("role"));

    }

   

    public Long extractUserId(String token) {

        return extractClaim(token, claims -> {

            Object userId = claims.get("userId");

            if (userId instanceof Integer) {

                return ((Integer) userId).longValue();

            }

            return (Long) userId;

        });

    }

   

    public <T> T extractClaim(String token, Function<Claims, T> claimsResolver) {

        final Claims claims = extractAllClaims(token);

        return claimsResolver.apply(claims);

    }

   

    private Claims extractAllClaims(String token) {

        return Jwts.parserBuilder()

                .setSigningKey(getSigningKey())

                .build()

                .parseClaimsJws(token)

                .getBody();

    }

   

    public boolean isTokenValid(String token, String username) {

        final String extractedUsername = extractUsername(token);

        return (extractedUsername.equals(username) && !isTokenExpired(token));

    }

   

    private boolean isTokenExpired(String token) {

        return extractExpiration(token).before(new Date());

    }

   

    private Date extractExpiration(String token) {

        return extractClaim(token, Claims::getExpiration);

    }

   

    public Jwt<?, ?> parseToken(String token) {

        return Jwts.parserBuilder()

                .setSigningKey(getSigningKey())

                .build()

                .parse(token);

    }

}

 

 

 

 

Folder: Service

ActivityCategoryService.java

package com.example.demo.service;

 

import com.example.demo.entity.ActivityCategory;

import java.util.List;

 

public interface ActivityCategoryService {

    ActivityCategory createCategory(ActivityCategory category);

    ActivityCategory getCategory(Long id);

    List<ActivityCategory> getAllCategories();

}

 

 

 

ActivityLogService.java

package com.example.demo.service;

 

import com.example.demo.entity.ActivityLog;

import java.time.LocalDate;

import java.util.List;

public interface ActivityLogService {

    ActivityLog logActivity(Long userId, Long typeId, ActivityLog log);

    List<ActivityLog> getLogsByUser(Long userId);

    List<ActivityLog> getLogsByUserAndDate(Long userId, LocalDate start, LocalDate end);

    ActivityLog getLog(Long id);

}

 

 

 


ActivityTypeService.java

package com.example.demo.service;

import com.example.demo.entity.ActivityType;

import java.util.List;

 

public interface ActivityTypeService {

    ActivityType createType(Long categoryId, ActivityType type);

    ActivityType getType(Long id);

    List<ActivityType> getTypesByCategory(Long categoryId);

}

 

 

 

 

 



EmissionFactorService.java 

package com.example.demo.service;

 

import com.example.demo.entity.EmissionFactor;

import java.util.List;

 

public interface EmissionFactorService {

    EmissionFactor createFactor(Long activityTypeId, EmissionFactor factor);

    EmissionFactor getFactor(Long id);

    EmissionFactor getFactorByType(Long typeId);

    List<EmissionFactor> getAllFactors();

}

 

 

 

 

UserService.java

 

package com.example.demo.service;

 

import com.example.demo.entity.User;

import java.util.List;

 

public interface UserService {

    User registerUser(User user);

    User getUser(Long id);

    List<User> getAllUsers();

    User getByEmail(String email);

}

 

 

Folder Service/impl


ActivityCategoryServiceImpl.java

package com.example.demo.service.impl;

 

import com.example.demo.entity.ActivityCategory;

import com.example.demo.exception.ResourceNotFoundException;

import com.example.demo.exception.ValidationException;

import com.example.demo.repository.ActivityCategoryRepository;

import com.example.demo.service.ActivityCategoryService;

import org.springframework.stereotype.Service;

 

import java.util.List;

 

@Service

public class ActivityCategoryServiceImpl implements ActivityCategoryService {

   

    private final ActivityCategoryRepository categoryRepository;

   

    public ActivityCategoryServiceImpl(ActivityCategoryRepository categoryRepository) {

        this.categoryRepository = categoryRepository;

    }

   

    @Override

    public ActivityCategory createCategory(ActivityCategory category) {

        if (categoryRepository.existsByCategoryName(category.getCategoryName())) {

            throw new ValidationException("Category name must be unique");

        }

        return categoryRepository.save(category);

    }

   

    @Override

    public ActivityCategory getCategory(Long id) {

        return categoryRepository.findById(id)

                .orElseThrow(() -> new ResourceNotFoundException("Category not found"));

    }

   

    @Override

    public List<ActivityCategory> getAllCategories() {

        return categoryRepository.findAll();

    }

}

 

 

 

 

ActivityLogServiceImpl.java

package com.example.demo.service.impl;

import com.example.demo.entity.ActivityLog;

import com.example.demo.entity.ActivityType;

import com.example.demo.entity.EmissionFactor;

import com.example.demo.entity.User;

import com.example.demo.exception.ResourceNotFoundException;

import com.example.demo.exception.ValidationException;

import com.example.demo.repository.ActivityLogRepository;

import com.example.demo.repository.ActivityTypeRepository;

import com.example.demo.repository.EmissionFactorRepository;

import com.example.demo.repository.UserRepository;

import com.example.demo.service.ActivityLogService;

import org.springframework.stereotype.Service;

 

import java.time.LocalDate;

import java.util.List;

 

@Service

public class ActivityLogServiceImpl implements ActivityLogService {

   

    private final ActivityLogRepository logRepository;

    private final UserRepository userRepository;

    private final ActivityTypeRepository typeRepository;

    private final EmissionFactorRepository factorRepository;

   

    public ActivityLogServiceImpl(ActivityLogRepository logRepository, UserRepository userRepository,

                                 ActivityTypeRepository typeRepository, EmissionFactorRepository factorRepository) {

        this.logRepository = logRepository;

        this.userRepository = userRepository;

        this.typeRepository = typeRepository;

        this.factorRepository = factorRepository;

    }

   

    @Override

    public ActivityLog logActivity(Long userId, Long typeId, ActivityLog log) {

        User user = userRepository.findById(userId)

                .orElseThrow(() -> new ResourceNotFoundException("User not found"));

       

        ActivityType activityType = typeRepository.findById(typeId)

                .orElseThrow(() -> new ResourceNotFoundException("Category not found"));

       

        if (log.getActivityDate().isAfter(LocalDate.now())) {

            throw new ValidationException("Activity date cannot be in the future");

        }

       

        if (log.getQuantity() <= 0) {

            throw new ValidationException("Quantity must be greater than zero");

        }

       

        EmissionFactor factor = factorRepository.findByActivityType_Id(typeId)

                .orElseThrow(() -> new ValidationException("No emission factor configured"));

       

        log.setUser(user);

        log.setActivityType(activityType);

        log.setEstimatedEmission(log.getQuantity() * factor.getFactorValue());

       

        return logRepository.save(log);

    }

   

    @Override

    public List<ActivityLog> getLogsByUser(Long userId) {

        return logRepository.findByUser_Id(userId);

    }

   

    @Override

    public List<ActivityLog> getLogsByUserAndDate(Long userId, LocalDate start, LocalDate end) {

        return logRepository.findByUser_IdAndActivityDateBetween(userId, start, end);

    }

   

    @Override

    public ActivityLog getLog(Long id) {

        return logRepository.findById(id)

                .orElseThrow(() -> new ResourceNotFoundException("Activity log not found"));

    }

}

 

 

 

 

 

 

ActivityTypeServiceImpl.java

package com.example.demo.service.impl;

 

import com.example.demo.entity.ActivityCategory;

import com.example.demo.entity.ActivityType;

import com.example.demo.exception.ResourceNotFoundException;

import com.example.demo.exception.ValidationException;

import com.example.demo.repository.ActivityCategoryRepository;

import com.example.demo.repository.ActivityTypeRepository;

import com.example.demo.service.ActivityTypeService;

import org.springframework.stereotype.Service;

 

import java.util.List;

 

@Service

public class ActivityTypeServiceImpl implements ActivityTypeService {

   

    private final ActivityTypeRepository typeRepository;

    private final ActivityCategoryRepository categoryRepository;

   

    public ActivityTypeServiceImpl(ActivityTypeRepository typeRepository, ActivityCategoryRepository categoryRepository) {

        this.typeRepository = typeRepository;

        this.categoryRepository = categoryRepository;

    }

   

    @Override

    public ActivityType createType(Long categoryId, ActivityType type) {

        ActivityCategory category = categoryRepository.findById(categoryId)

                .orElseThrow(() -> new ResourceNotFoundException("Category not found"));

       

        if (type.getUnit() == null || type.getUnit().trim().isEmpty()) {

            throw new ValidationException("Unit must be provided");

        }

       

        type.setCategory(category);

        return typeRepository.save(type);

    }

   

    @Override

    public ActivityType getType(Long id) {

        return typeRepository.findById(id)

                .orElseThrow(() -> new ResourceNotFoundException("Activity type not found"));

    }

   

    @Override

    public List<ActivityType> getTypesByCategory(Long categoryId) {

        return typeRepository.findByCategory_Id(categoryId);

    }

}

 

 

 

 





EmissionFactorServiceImpl.java

package com.example.demo.service.impl;

 

import com.example.demo.entity.ActivityType;

import com.example.demo.entity.EmissionFactor;

import com.example.demo.exception.ResourceNotFoundException;

import com.example.demo.exception.ValidationException;

import com.example.demo.repository.ActivityTypeRepository;

import com.example.demo.repository.EmissionFactorRepository;

import com.example.demo.service.EmissionFactorService;

import org.springframework.stereotype.Service;

 

import java.util.List;

 

@Service

public class EmissionFactorServiceImpl implements EmissionFactorService {

   

    private final EmissionFactorRepository factorRepository;

    private final ActivityTypeRepository typeRepository;

   

    public EmissionFactorServiceImpl(EmissionFactorRepository factorRepository, ActivityTypeRepository typeRepository) {

        this.factorRepository = factorRepository;

        this.typeRepository = typeRepository;

    }

   

    @Override

    public EmissionFactor createFactor(Long activityTypeId, EmissionFactor factor) {

        ActivityType activityType = typeRepository.findById(activityTypeId)

                .orElseThrow(() -> new ResourceNotFoundException("Category not found"));

       

        if (factor.getFactorValue() <= 0) {

            throw new ValidationException("Factor value must be greater than zero");

        }

       

        factor.setActivityType(activityType);

        return factorRepository.save(factor);

    }

   

    @Override

    public EmissionFactor getFactor(Long id) {

        return factorRepository.findById(id)

                .orElseThrow(() -> new ResourceNotFoundException("Emission factor not found"));

    }

   

    @Override

    public EmissionFactor getFactorByType(Long typeId) {

        return factorRepository.findByActivityType_Id(typeId)

                .orElseThrow(() -> new ResourceNotFoundException("Emission factor not found"));

    }

   

    @Override

    public List<EmissionFactor> getAllFactors() {

        return factorRepository.findAll();

    }

}

 

 

 

 





UserServiceImpl.java

package com.example.demo.service.impl;

 

import com.example.demo.entity.User;

import com.example.demo.exception.ResourceNotFoundException;

import com.example.demo.exception.ValidationException;

import com.example.demo.repository.UserRepository;

import com.example.demo.service.UserService;

import org.springframework.security.crypto.password.PasswordEncoder;

import org.springframework.stereotype.Service;

 

import java.util.List;

 

@Service

public class UserServiceImpl implements UserService {

   

    private final UserRepository userRepository;

    private final PasswordEncoder passwordEncoder;

   

    public UserServiceImpl(UserRepository userRepository, PasswordEncoder passwordEncoder) {

        this.userRepository = userRepository;

        this.passwordEncoder = passwordEncoder;

    }

   

    @Override

    public User registerUser(User user) {

        if (userRepository.existsByEmail(user.getEmail())) {

            throw new ValidationException("Email already in use");

        }

       

        if (user.getPassword().length() < 8) {

            throw new ValidationException("Password must be at least 8 characters");

        }

       

        user.setPassword(passwordEncoder.encode(user.getPassword()));

       

        if (user.getRole() == null || user.getRole().isEmpty()) {

            user.setRole("USER");

        }

       

        return userRepository.save(user);

    }

   

    @Override

    public User getUser(Long id) {

        return userRepository.findById(id)

                .orElseThrow(() -> new ResourceNotFoundException("User not found"));

    }

   

    @Override

    public List<User> getAllUsers() {

        return userRepository.findAll();

    }

   

    @Override

    public User getByEmail(String email) {

        return userRepository.findByEmail(email)

                .orElseThrow(() -> new ResourceNotFoundException("User not found"));

    }

}

 

 






Application.properties

# Database Configuration (H2 for testing)

spring.datasource.url=jdbc:h2:mem:testdb

spring.datasource.driver-class-name=org.h2.Driver

spring.datasource.username=sa

spring.datasource.password=password

 

# JPA Configuration

spring.jpa.database-platform=org.hibernate.dialect.H2Dialect

spring.jpa.hibernate.ddl-auto=create-drop

spring.jpa.show-sql=true

 

# H2 Console (for debugging)

spring.h2.console.enabled=true

 

# Server Configuration

server.port=8081

 

# Swagger Configuration

springdoc.api-docs.path=/v3/api-docs

springdoc.swagger-ui.path=/swagger-ui.html

 

 

 





pom.xml

<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">

    <modelVersion>4.0.0</modelVersion>

    <parent>

        <groupId>org.springframework.boot</groupId>

        <artifactId>spring-boot-starter-parent</artifactId>

        <version>3.2.0</version>

        <relativePath/> <!-- lookup parent from repository -->

    </parent>

    <groupId>com.example</groupId>

    <artifactId>demo</artifactId>

    <version>0.0.1-SNAPSHOT</version>

    <name>demo</name>

    <description>Demo project for Spring Boot</description>

    <properties>

        <java.version>17</java.version>

    </properties>

    <dependencies>

        <dependency>

            <groupId>org.springframework.boot</groupId>

            <artifactId>spring-boot-starter-data-jpa</artifactId>

        </dependency>

        <dependency>

            <groupId>org.springframework.boot</groupId>

            <artifactId>spring-boot-starter-web</artifactId>

        </dependency>

        <dependency>

            <groupId>org.springframework.boot</groupId>

            <artifactId>spring-boot-starter-security</artifactId>

        </dependency>

        <dependency>

            <groupId>org.springframework.boot</groupId>

            <artifactId>spring-boot-starter-validation</artifactId>

        </dependency>

        <dependency>

            <groupId>io.jsonwebtoken</groupId>

            <artifactId>jjwt-api</artifactId>

            <version>0.11.5</version>

        </dependency>

        <dependency>

            <groupId>io.jsonwebtoken</groupId>

            <artifactId>jjwt-impl</artifactId>

            <version>0.11.5</version>

            <scope>runtime</scope>

        </dependency>

        <dependency>

            <groupId>io.jsonwebtoken</groupId>

            <artifactId>jjwt-jackson</artifactId>

            <version>0.11.5</version>

            <scope>runtime</scope>

        </dependency>

        <dependency>

            <groupId>org.springdoc</groupId>

            <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>

            <version>2.2.0</version>

        </dependency>

        <dependency>

            <groupId>com.h2database</groupId>

            <artifactId>h2</artifactId>

            <scope>runtime</scope>

        </dependency>

        <dependency>

            <groupId>com.mysql</groupId>

            <artifactId>mysql-connector-j</artifactId>

            <scope>runtime</scope>

        </dependency>

        <dependency>

            <groupId>org.springframework.boot</groupId>

            <artifactId>spring-boot-starter-test</artifactId>

            <scope>test</scope>

        </dependency>

        <dependency>

            <groupId>org.springframework.security</groupId>

            <artifactId>spring-security-test</artifactId>

            <scope>test</scope>

        </dependency>

    </dependencies>

 

    <build>

        <plugins>

            <plugin>

                <groupId>org.springframework.boot</groupId>

                <artifactId>spring-boot-maven-plugin</artifactId>

            </plugin>

        </plugins>

    </build>

 

</project>

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 